#!/bin/bash

echo "?????????????????????????????????????????????????????????????"
echo "?                                                           ?"
echo "?   ?? TESTE COMPLETO: Webhook Flow                         ?"
echo "?                                                           ?"
echo "?????????????????????????????????????????????????????????????"
echo ""

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}?? Passo 1: Verificando se API est? rodando...${NC}"
API_STATUS=$(curl -s http://127.0.0.1:8080/health 2>/dev/null)
if [ $? -eq 0 ]; then
    echo -e "${GREEN}? API est? rodando${NC}"
else
    echo -e "${RED}? API n?o est? rodando${NC}"
    echo -e "${YELLOW}  Inicie o Flui: npm run dev${NC}"
    exit 1
fi
echo ""

echo -e "${CYAN}?? Passo 2: Verificando webhookConfig na automa??o...${NC}"
cd /workspace/youtube-cli
HAS_WEBHOOK=$(cat automations/youtube-webhook-trigger.json | grep -o '"enabled": true' | wc -l)
if [ $HAS_WEBHOOK -gt 0 ]; then
    echo -e "${GREEN}? Automa??o tem webhookConfig enabled${NC}"
else
    echo -e "${RED}? Automa??o n?o tem webhookConfig${NC}"
    exit 1
fi
echo ""

echo -e "${CYAN}?? Passo 3: Extraindo webhook info do JSON...${NC}"
METHOD=$(cat automations/youtube-webhook-trigger.json | grep -A 5 '"webhookConfig"' | grep '"method"' | cut -d'"' -f4)
REQUIRE_AUTH=$(cat automations/youtube-webhook-trigger.json | grep -A 5 '"webhookConfig"' | grep '"requireAuth"' | cut -d':' -f2 | tr -d ' ,')
echo -e "${GREEN}? Method: $METHOD${NC}"
echo -e "${GREEN}? RequireAuth: $REQUIRE_AUTH${NC}"
echo ""

echo "?????????????????????????????????????????????????????????????"
echo "?                                                           ?"
echo "?   ?? INSTRU??ES DE TESTE MANUAL                           ?"
echo "?                                                           ?"
echo "?????????????????????????????????????????????????????????????"
echo ""
echo -e "${YELLOW}1. Abra o Flui em um terminal:${NC}"
echo "   cd /workspace/youtube-cli"
echo "   npm run dev"
echo ""
echo -e "${YELLOW}2. Digite no Flui:${NC}"
echo "   @"
echo ""
echo -e "${YELLOW}3. Selecione:${NC}"
echo "   YouTube Webhook Analysis"
echo ""
echo -e "${YELLOW}4. VERIFIQUE se aparece:${NC}"
echo "   ${GREEN}?${NC} ?? Setting up webhook for: YouTube Webhook Analysis"
echo "   ${GREEN}?${NC} ?? Webhook Created Successfully"
echo "   ${GREEN}?${NC} URL: http://127.0.0.1:8080/webhook/..."
echo "   ${GREEN}?${NC} Method: POST"
echo "   ${GREEN}?${NC} Authorization: Bearer sk-..."
echo "   ${GREEN}?${NC} Expected Payload: {...}"
echo ""
echo -e "${YELLOW}5. VERIFIQUE se automa??o N?O executa ainda${NC}"
echo "   ${RED}?${NC} Se aparecer \"Executing automation\" = ERRO"
echo "   ${GREEN}?${NC} Deve apenas mostrar dados do webhook e parar"
echo ""
echo -e "${YELLOW}6. Copie a URL do webhook e execute (novo terminal):${NC}"
echo "   curl -X POST <URL-DO-WEBHOOK> \\"
echo "     -H \"Authorization: Bearer <TOKEN>\" \\"
echo "     -H \"Content-Type: application/json\" \\"
echo "     -d '{\"searchTopic\": \"artificial intelligence\"}'"
echo ""
echo -e "${YELLOW}7. AGORA SIM deve executar:${NC}"
echo "   ${GREEN}?${NC} ?? Webhook triggered for: YouTube Webhook Analysis"
echo "   ${GREEN}?${NC} ?? Executing automation..."
echo "   ${GREEN}?${NC} ?? search_youtube_comments"
echo "   ${GREEN}?${NC} ? Complete!"
echo ""
echo "?????????????????????????????????????????????????????????????"
echo "?                                                           ?"
echo "?   ??  COMPORTAMENTO ESPERADO                              ?"
echo "?                                                           ?"
echo "?????????????????????????????????????????????????????????????"
echo ""
echo -e "${GREEN}CORRETO:${NC}"
echo "  1. Seleciona automa??o"
echo "  2. Mostra dados do webhook"
echo "  3. PARA e aguarda"
echo "  4. Usu?rio pode conversar normalmente"
echo "  5. Webhook disparado ? Executa"
echo ""
echo -e "${RED}ERRADO:${NC}"
echo "  1. Seleciona automa??o"
echo "  2. Mostra dados do webhook"
echo "  3. EXECUTA IMEDIATAMENTE ? PROBLEMA!"
echo ""
echo "?????????????????????????????????????????????????????????????"
echo "?                                                           ?"
echo "?   ?? VERIFICA??O DE C?DIGO                                ?"
echo "?                                                           ?"
echo "?????????????????????????????????????????????????????????????"
echo ""

echo -e "${CYAN}Verificando app.tsx...${NC}"
HAS_SETUP_ONLY=$(cat source/app.tsx | grep -A 2 "webhookTriggerHandler.hasWebhookConfig" | grep "ONLY setup" | wc -l)
if [ $HAS_SETUP_ONLY -gt 0 ]; then
    echo -e "${GREEN}? C?digo tem coment?rio 'ONLY setup'${NC}"
else
    echo -e "${RED}? C?digo n?o tem coment?rio esperado${NC}"
fi

HAS_NOT_BUSY=$(cat source/app.tsx | grep "NOT busy" | wc -l)
if [ $HAS_NOT_BUSY -gt 0 ]; then
    echo -e "${GREEN}? C?digo indica 'NOT busy' para webhook${NC}"
else
    echo -e "${RED}? C?digo n?o indica NOT busy${NC}"
fi

HAS_SET_BUSY_WEBHOOK=$(cat source/app.tsx | grep -B 5 "webhookTriggerHandler.hasWebhookConfig" | grep "setBusy(true)" | wc -l)
if [ $HAS_SET_BUSY_WEBHOOK -eq 0 ]; then
    echo -e "${GREEN}? Webhook N?O seta busy antes do setup${NC}"
else
    echo -e "${RED}? Webhook est? setando busy (ERRO!)${NC}"
fi

echo ""
echo "?????????????????????????????????????????????????????????????"
echo "?   Execute o teste manual acima e reporte o resultado     ?"
echo "?????????????????????????????????????????????????????????????"
