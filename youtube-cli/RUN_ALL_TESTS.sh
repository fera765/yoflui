#!/bin/bash
##
# RUN ALL TESTS - Sistema Completo de Valida??o
##

echo "?????????????????????????????????????????????????????????????"
echo "?         FLUI - SUITE COMPLETA DE TESTES                  ?"
echo "?????????????????????????????????????????????????????????????"
echo ""

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
PASSED=0
FAILED=0
TOTAL=5

# Build first
echo "?? Building project..."
npm run build > /dev/null 2>&1

if [ $? -ne 0 ]; then
    echo -e "${RED}? Build failed${NC}"
    exit 1
fi

echo -e "${GREEN}? Build successful${NC}"
echo ""

# Test 1: Webhook Automation
echo "???????????????????????????????????????????????????????????"
echo "Running Test 1: Automation com Webhook Trigger"
echo "???????????????????????????????????????????????????????????"
node tests/test-1-automation-webhook.mjs
TEST1_RESULT=$?
if [ $TEST1_RESULT -eq 0 ]; then
    PASSED=$((PASSED + 1))
    echo -e "${GREEN}? Test 1 PASSED${NC}"
else
    FAILED=$((FAILED + 1))
    echo -e "${RED}? Test 1 FAILED${NC}"
fi
echo ""

# Test 2: Resilience
echo "???????????????????????????????????????????????????????????"
echo "Running Test 2: Resilience - Retry e Timeout"
echo "???????????????????????????????????????????????????????????"
node tests/test-2-tool-execution-retry.mjs
TEST2_RESULT=$?
if [ $TEST2_RESULT -eq 0 ]; then
    PASSED=$((PASSED + 1))
    echo -e "${GREEN}? Test 2 PASSED${NC}"
else
    FAILED=$((FAILED + 1))
    echo -e "${RED}? Test 2 FAILED${NC}"
fi
echo ""

# Test 3: Context Preservation
echo "???????????????????????????????????????????????????????????"
echo "Running Test 3: Preserva??o de Contexto"
echo "???????????????????????????????????????????????????????????"
node tests/test-3-conversation-context.mjs
TEST3_RESULT=$?
if [ $TEST3_RESULT -eq 0 ]; then
    PASSED=$((PASSED + 1))
    echo -e "${GREEN}? Test 3 PASSED${NC}"
else
    FAILED=$((FAILED + 1))
    echo -e "${RED}? Test 3 FAILED${NC}"
fi
echo ""

# Test 4: UI Feedback
echo "???????????????????????????????????????????????????????????"
echo "Running Test 4: Feedback Visual e UI"
echo "???????????????????????????????????????????????????????????"
node tests/test-4-ui-feedback.mjs
TEST4_RESULT=$?
if [ $TEST4_RESULT -eq 0 ]; then
    PASSED=$((PASSED + 1))
    echo -e "${GREEN}? Test 4 PASSED${NC}"
else
    FAILED=$((FAILED + 1))
    echo -e "${RED}? Test 4 FAILED${NC}"
fi
echo ""

# Test 5: Stress Test
echo "???????????????????????????????????????????????????????????"
echo "Running Test 5: Stress Test - M?ltiplas Tools"
echo "???????????????????????????????????????????????????????????"
node tests/test-5-stress-multiple-tools.mjs
TEST5_RESULT=$?
if [ $TEST5_RESULT -eq 0 ]; then
    PASSED=$((PASSED + 1))
    echo -e "${GREEN}? Test 5 PASSED${NC}"
else
    FAILED=$((FAILED + 1))
    echo -e "${RED}? Test 5 FAILED${NC}"
fi
echo ""

# Final Results
echo "?????????????????????????????????????????????????????????????"
echo "?                  RESULTADOS FINAIS                        ?"
echo "?????????????????????????????????????????????????????????????"
echo ""
echo -e "? Passed: ${GREEN}${PASSED}${NC}/${TOTAL}"
echo -e "? Failed: ${RED}${FAILED}${NC}/${TOTAL}"
echo ""

if [ $PASSED -eq $TOTAL ]; then
    echo -e "${GREEN}?? TODOS OS TESTES PASSARAM!${NC}"
    exit 0
elif [ $PASSED -ge 3 ]; then
    echo -e "${YELLOW}??  MAIORIA DOS TESTES PASSARAM${NC}"
    exit 0
else
    echo -e "${RED}? MUITOS TESTES FALHARAM${NC}"
    exit 1
fi
