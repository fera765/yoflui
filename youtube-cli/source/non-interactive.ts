/**
 * Non-interactive mode for CLI
 * Usage: npm run start --prompt "Your question here"
 */

import { setConfig, getConfig } from './llm-config.js';
import { sendMessage } from './llm-service.js';
import { readFileSync } from 'fs';
import { join } from 'path';

interface ConfigFile {
	endpoint: string;
	apiKey: string;
	model: string;
	maxVideos: number;
	maxCommentsPerVideo: number;
}

function loadConfig(): ConfigFile {
	try {
		const configPath = join(process.cwd(), 'config.json');
		const configData = readFileSync(configPath, 'utf-8');
		const config = JSON.parse(configData) as ConfigFile;
		
		console.log('\n?? Loaded configuration:');
		console.log(`   Endpoint: ${config.endpoint}`);
		console.log(`   Model: ${config.model}`);
		console.log(`   Max Videos: ${config.maxVideos}`);
		console.log(`   Max Comments/Video: ${config.maxCommentsPerVideo}`);
		console.log('');
		
		return config;
	} catch (error) {
		console.error('? Failed to load config.json:', error);
		console.log('?? Using default configuration...\n');
		
		return {
			endpoint: 'http://localhost:4000/v1',
			apiKey: '',
			model: 'gemini',
			maxVideos: 7,
			maxCommentsPerVideo: 10,
		};
	}
}

export async function runNonInteractive(prompt: string): Promise<void> {
	console.log('?????????????????????????????????????????????????????????');
	console.log('?        ?? AI YOUTUBE ANALYST - NON-INTERACTIVE       ?');
	console.log('?????????????????????????????????????????????????????????\n');

	// Load and apply config
	const config = loadConfig();
	setConfig({
		endpoint: config.endpoint,
		apiKey: config.apiKey,
		model: config.model,
		maxVideos: config.maxVideos,
		maxCommentsPerVideo: config.maxCommentsPerVideo,
	});

	console.log('? User Prompt:');
	console.log(`   "${prompt}"\n`);

	console.log('? Processing...\n');

	try {
		let toolExecuted = false;
		let toolResult: any = null;

		const response = await sendMessage(
			prompt,
			(toolName, query) => {
				toolExecuted = true;
				console.log('?? Tool Called:');
				console.log(`   Name: ${toolName}`);
				console.log(`   Query: "${query}"`);
				console.log('');
			},
			(result) => {
				toolResult = result;
				console.log('? Tool Completed:');
				console.log(`   Videos: ${result.totalVideos}`);
				console.log(`   Comments: ${result.totalComments}`);
				console.log('');
			}
		);

		console.log('?????????????????????????????????????????????????????????');
		console.log('?                    ?? RESULTS                         ?');
		console.log('?????????????????????????????????????????????????????????\n');

		if (toolExecuted && toolResult) {
			console.log('?? Data Collection:');
			console.log(`   ? ${toolResult.totalVideos} videos analyzed`);
			console.log(`   ? ${toolResult.totalComments} comments extracted`);
			console.log('');
		}

		console.log('?? AI Analysis:\n');
		console.log(response);
		console.log('\n');

		console.log('?????????????????????????????????????????????????????????');
		console.log('?                    ? COMPLETE                        ?');
		console.log('?????????????????????????????????????????????????????????\n');

		process.exit(0);
	} catch (error) {
		console.error('\n? Error:');
		console.error(error);
		console.log('');
		process.exit(1);
	}
}
