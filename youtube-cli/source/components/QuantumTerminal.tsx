import React from 'react';
import { Box, Text } from 'ink';
import Spinner from 'ink-spinner';
import TextInput from 'ink-text-input';
import type { KanbanTask } from '../tools/kanban.js';

export interface Message {
	role: 'user' | 'assistant' | 'tool' | 'kanban';
	content: string;
	toolCall?: {
		name: string;
		args: any;
		status: 'running' | 'complete' | 'error';
		result?: string;
		progress?: number;
	};
	kanban?: KanbanTask[];
}

// ???????????????????????????????????????????????????????????????
// QUANTUM TERMINAL HEADER
// ???????????????????????????????????????????????????????????????
export const QuantumHeader: React.FC<{ model: string; count: number }> = ({ model, count }) => (
	<Box borderStyle="double" borderColor="#30363D" paddingX={2} paddingY={0} width="100%">
		<Box width="100%" justifyContent="center">
			<Text bold color="#00C6FF">? QUANTUM TERMINAL v1.0 ?</Text>
		</Box>
	</Box>
);

// ???????????????????????????????????????????????????????????????
// USER MESSAGE
// ???????????????????????????????????????????????????????????????
const UserMessage: React.FC<{ text: string }> = ({ text }) => (
	<Box flexDirection="column" marginTop={1} marginBottom={1}>
		<Box>
			<Text color="#58A6FF" bold>&gt; </Text>
			<Text color="#C9D1D9">{text}</Text>
		</Box>
	</Box>
);

// ???????????????????????????????????????????????????????????????
// KANBAN BOARD
// ???????????????????????????????????????????????????????????????
const QuantumKanban: React.FC<{ tasks: KanbanTask[] }> = ({ tasks }) => {
	const todoTasks = tasks.filter(t => t.status === 'todo');
	const inProgressTasks = tasks.filter(t => t.status === 'in_progress');
	const doneTasks = tasks.filter(t => t.status === 'done');

	return (
		<Box borderStyle="round" borderColor="#30363D" paddingX={2} paddingY={1} flexDirection="column" marginY={1}>
			<Box marginBottom={1}>
				<Text color="#00C6FF" bold>?? TASK BOARD</Text>
			</Box>
			
			{todoTasks.length > 0 && (
				<Box flexDirection="column" marginBottom={1}>
					<Text color="#F0C674" bold>? PENDING ({todoTasks.length})</Text>
					{todoTasks.map(task => (
						<Box key={task.id} marginLeft={2}>
							<Text color="#C9D1D9">  ? {task.title}</Text>
						</Box>
					))}
				</Box>
			)}

			{inProgressTasks.length > 0 && (
				<Box flexDirection="column" marginBottom={1}>
					<Text color="#F0C674" bold>?? IN PROGRESS ({inProgressTasks.length})</Text>
					{inProgressTasks.map(task => (
						<Box key={task.id} marginLeft={2}>
							<Text color="#F0C674">  ? {task.title}</Text>
						</Box>
					))}
				</Box>
			)}

			{doneTasks.length > 0 && (
				<Box flexDirection="column">
					<Text color="#56D364" bold>? COMPLETED ({doneTasks.length})</Text>
					{doneTasks.map(task => (
						<Box key={task.id} marginLeft={2}>
							<Text color="#56D364">  ? {task.title}</Text>
						</Box>
					))}
				</Box>
			)}
		</Box>
	);
};

// ???????????????????????????????????????????????????????????????
// TOOL EXECUTION BOX
// ???????????????????????????????????????????????????????????????
const QuantumTool: React.FC<{
	name: string;
	args: any;
	status: 'running' | 'complete' | 'error';
	result?: string;
	progress?: number;
}> = ({ name, args, status, result, progress }) => {
	const getIcon = () => {
		switch (name) {
			case 'write_file': return '??';
			case 'read_file': return '??';
			case 'edit_file': return '??';
			case 'execute_shell': return '??';
			case 'find_files': return '??';
			case 'search_text': return '??';
			case 'read_folder': return '??';
			case 'update_kanban': return '??';
			case 'web_fetch': return '??';
			default: return '??';
		}
	};

	const getStatusIcon = () => {
		if (status === 'running') return '?';
		if (status === 'complete') return '?';
		return '?';
	};

	const getColor = () => {
		if (status === 'running') return '#F0C674';
		if (status === 'complete') return '#56D364';
		return '#F85149';
	};

	const getStatusText = () => {
		if (status === 'running') return 'Executando...';
		if (status === 'complete') return 'Conclu?do';
		return 'Erro';
	};

	// Progress bar
	const renderProgressBar = () => {
		if (status !== 'running') return null;
		const prog = progress || 50;
		const filled = Math.floor((prog / 100) * 10);
		const empty = 10 - filled;
		return (
			<Box marginLeft={2} marginTop={1}>
				<Text color="#C9D1D9">  ? Status: </Text>
				<Text color="#56D364">{'?'.repeat(filled)}</Text>
				<Text color="#30363D">{'?'.repeat(empty)}</Text>
				<Text color="#C9D1D9"> {prog}%</Text>
			</Box>
		);
	};

	// Get first 3 lines of output for running, or first 5 for complete
	const getOutputLines = () => {
		if (!result) return [];
		const lines = result.split('\n').filter(l => l.trim());
		if (status === 'running') return lines.slice(0, 3);
		return lines.slice(0, 5);
	};

	const formatArgValue = (value: any): string => {
		if (typeof value === 'string') return value.substring(0, 60);
		return JSON.stringify(value).substring(0, 60);
	};

	return (
		<Box flexDirection="column" marginY={1}>
			<Box>
				<Text color={getColor()} bold>
					[Tool {getIcon()}: {name.replace('_', ' ').toUpperCase()}]  {getStatusIcon()} {getStatusText()}
				</Text>
			</Box>

			{/* Args */}
			{Object.entries(args).slice(0, 2).map(([key, value]) => (
				<Box key={key} marginLeft={2}>
					<Text color="#C9D1D9">  ? {key}: </Text>
					<Text color="#A5D6FF">{formatArgValue(value)}</Text>
				</Box>
			))}

			{/* Progress bar for running */}
			{renderProgressBar()}

			{/* Output lines */}
			{result && getOutputLines().map((line, idx) => (
				<Box key={idx} marginLeft={2}>
					<Text color={status === 'error' ? '#F85149' : '#C9D1D9'}>  {line}</Text>
				</Box>
			))}

			{result && result.split('\n').length > 5 && status === 'complete' && (
				<Box marginLeft={2}>
					<Text color="#6B7280" dimColor>    ( +{result.split('\n').length - 5} linhas anteriores omitidas )</Text>
				</Box>
			)}
		</Box>
	);
};

// ???????????????????????????????????????????????????????????????
// AI RESPONSE
// ???????????????????????????????????????????????????????????????
const AIResponse: React.FC<{ text: string }> = ({ text }) => (
	<Box flexDirection="column" marginY={1} paddingX={1}>
		<Text color="#A5D6FF">{text}</Text>
	</Box>
);

// ???????????????????????????????????????????????????????????????
// TIMELINE
// ???????????????????????????????????????????????????????????????
export const QuantumTimeline: React.FC<{ messages: Message[] }> = ({ messages }) => {
	if (messages.length === 0) {
		return (
			<Box flexDirection="column" alignItems="center" justifyContent="center" flexGrow={1} paddingY={5}>
				<Text color="#00C6FF" bold>?</Text>
				<Box marginTop={1}>
					<Text color="#6B7280">Quantum Terminal ready. Type your command below.</Text>
				</Box>
			</Box>
		);
	}

	return (
		<Box flexDirection="column" paddingX={2} paddingY={1}>
			{messages.map((msg, idx) => {
				if (msg.role === 'user') {
					return <UserMessage key={idx} text={msg.content} />;
				}

				if (msg.role === 'kanban' && msg.kanban) {
					return <QuantumKanban key={idx} tasks={msg.kanban} />;
				}

				if (msg.role === 'tool' && msg.toolCall) {
					return (
						<QuantumTool
							key={idx}
							name={msg.toolCall.name}
							args={msg.toolCall.args}
							status={msg.toolCall.status}
							result={msg.toolCall.result}
							progress={msg.toolCall.progress}
						/>
					);
				}

				if (msg.role === 'assistant') {
					return <AIResponse key={idx} text={msg.content} />;
				}

				return null;
			})}
		</Box>
	);
};

// ???????????????????????????????????????????????????????????????
// INPUT BOX
// ???????????????????????????????????????????????????????????????
export const QuantumInput: React.FC<{
	value: string;
	onChange: (val: string) => void;
	onSubmit: () => void;
	isProcessing: boolean;
}> = ({ value, onChange, onSubmit, isProcessing }) => (
	<Box flexDirection="column">
		<Box borderStyle="single" borderColor="#30363D" width="100%" paddingX={1}>
			<Box width="100%" justifyContent="center">
				<Text color="#6B7280" dimColor>????????????????????????????????????????????????????????????????????????</Text>
			</Box>
		</Box>
		<Box paddingX={2} paddingY={1}>
			<Text color="#6B7280" dimColor>??  Digite seu comando abaixo...</Text>
		</Box>
		<Box borderStyle="round" borderColor="#30363D" paddingX={2} paddingY={1} marginX={2}>
			{isProcessing ? (
				<>
					<Text color="#F0C674"><Spinner type="dots" /></Text>
					<Text color="#6B7280"> Processando...</Text>
				</>
			) : (
				<>
					<Text color="#58A6FF" bold>&gt; </Text>
					<TextInput
						value={value}
						onChange={onChange}
						onSubmit={onSubmit}
						placeholder=""
					/>
				</>
			)}
		</Box>
		<Box paddingX={2} paddingBottom={1}>
			<Text color="#6B7280" dimColor>[Enter ? enviar | ?? hist?rico | Ctrl+C sair]</Text>
		</Box>
	</Box>
);
